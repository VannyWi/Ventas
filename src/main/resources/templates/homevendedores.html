<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Panel Vendedor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .filter-group { font-size: 0.85rem; }
        .filter-group input { padding: 0.25rem 0.5rem; font-size: 0.85rem; }
    </style>
</head>
<body class="bg-light">

    <div th:if="${userLog.rol == 'VENDEDOR'}">
        <div th:replace="~{layout/fragments :: navbarVendedor}"></div>
    </div>

    <div class="container-fluid px-4 py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="mb-0 text-gray-800">Hola, <span th:text="${nombreVendedor}" class="text-primary fw-bold"></span></h4>
                <small class="text-muted">Tienda: <span th:text="${nombreTienda}"></span></small>
            </div>
            <a th:href="@{/ventas/crear}" class="btn btn-primary shadow-sm">
                <i class="bi bi-cart-plus me-2"></i>Nueva Venta
            </a>
        </div>

        <div class="row g-4 mb-4">
            <div class="col-md-6 col-xl-4">
                <div class="card bg-white shadow-sm h-100 border-start border-4 border-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Mis Ventas (Hoy)</p>
                                <h3 class="text-info fw-bold" th:text="'S/. ' + ${#numbers.formatDecimal(misVentas, 1, 'COMMA', 2, 'POINT')}"></h3>
                            </div>
                            <i class="bi bi-cash-coin fs-1 text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-xl-4">
                <div class="card bg-white shadow-sm h-100 border-start border-4 border-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Tickets (Hoy)</p>
                                <h3 class="text-success fw-bold" th:text="${misTickets}"></h3>
                            </div>
                            <i class="bi bi-receipt fs-1 text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-12 col-xl-4">
                <div class="card bg-white shadow-sm h-100 border-start border-4 border-danger">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="text-uppercase text-muted small fw-bold mb-1">Stock Bajo (Mi Tienda)</p>
                                <h3 class="text-danger fw-bold" th:text="${alertaStock}">0</h3>
                            </div>
                            <i class="bi bi-box-seam fs-1 text-danger opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4 mb-4">
            
            <div class="col-lg-5">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h6 class="m-0 fw-bold text-dark"><i class="bi bi-wallet2 me-2 text-primary"></i>Métodos Pago (Cant.)</h6>
                        
                        <div class="d-flex align-items-center gap-2 filter-group bg-light p-1 rounded">
                            <input type="date" id="startPago" th:value="${fechaHoy}" class="form-control border-0 bg-transparent" style="width: 110px;">
                            <span class="text-muted">-</span>
                            <input type="date" id="endPago" th:value="${fechaHoy}" class="form-control border-0 bg-transparent" style="width: 110px;">
                            <button onclick="actualizarGrafico()" class="btn btn-sm btn-primary"><i class="bi bi-search"></i></button>
                        </div>
                    </div>
                    <div class="card-body d-flex justify-content-center align-items-center">
                        <div style="height: 250px; width: 100%;"><canvas id="chartPagos"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="col-lg-7">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                        <h6 class="m-0 fw-bold text-danger"><i class="bi bi-exclamation-triangle me-2"></i>Stock Crítico</h6>
                        <a th:href="@{/homevendedores/exportar-stock}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-file-earmark-excel me-1"></i>Excel
                        </a>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light sticky-top">
                                    <tr>
                                        <th class="ps-4">Producto</th>
                                        <th>Categoría</th>
                                        <th class="text-center">Stock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr th:each="prod : ${stockBajoTienda}">
                                        <td class="ps-4 fw-medium" th:text="${prod.nombre}"></td>
                                        <td class="small text-muted" th:text="${prod.categoria.nombre}"></td>
                                        <td class="text-center">
                                            <span class="badge bg-danger bg-opacity-10 text-danger" th:text="${prod.stock}"></span>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(stockBajoTienda)}">
                                        <td colspan="3" class="text-center py-4 text-muted">Inventario saludable.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white py-3">
                <form th:action="@{/homevendedores}" method="get" class="row g-3 align-items-center">
                    <div class="col-auto">
                        <h6 class="m-0 fw-bold text-dark"><i class="bi bi-clock-history me-2"></i>Mis Ventas</h6>
                    </div>
                    <div class="col-auto ms-auto">
                        <label class="visually-hidden">Desde</label>
                        <input type="date" name="fechaInicio" class="form-control form-control-sm" th:value="${fechaInicio}" required>
                    </div>
                    <div class="col-auto">
                        <label class="visually-hidden">Hasta</label>
                        <input type="date" name="fechaFin" class="form-control form-control-sm" th:value="${fechaFin}" required>
                    </div>
                    <div class="col-auto">
                        <button type="submit" class="btn btn-sm btn-dark"><i class="bi bi-filter me-1"></i>Filtrar</button>
                    </div>
                    <div class="col-auto border-start ps-3">
                        <a th:href="@{/homevendedores/exportar-ventas(fechaInicio=${fechaInicio}, fechaFin=${fechaFin})}" 
                           class="btn btn-sm btn-success text-white">
                            <i class="bi bi-file-excel me-1"></i>Exportar Lista
                        </a>
                    </div>
                </form>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Ticket</th>
                                <th>Fecha</th>
                                <th>Cliente</th>
                                <th>Método</th>
                                <th class="text-end pe-4">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="v : ${historialVentas}">
                                <td class="ps-4 fw-bold text-primary" th:text="${v.numeroVenta}"></td>
                                <td th:text="${#temporals.format(v.fecha, 'dd/MM/yyyy HH:mm')}"></td>
                                <td th:text="${v.cliente != null ? v.cliente.nombre : 'Público'}"></td>
                                <td><span class="badge bg-light text-dark border" th:text="${v.metodoPago}"></span></td>
                                <td class="text-end pe-4 fw-bold" th:text="'S/. ' + ${#numbers.formatDecimal(v.montoTotal, 1, 'COMMA', 2, 'POINT')}"></td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(historialVentas)}">
                                <td colspan="5" class="text-center py-4">No hay ventas en este rango de fechas.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script th:inline="javascript">
        let chartPago;

        document.addEventListener("DOMContentLoaded", function() {
            actualizarGrafico();
        });

        function actualizarGrafico() {
            let start = document.getElementById('startPago').value;
            let end = document.getElementById('endPago').value;
            let url = '/api/vendedor/grafico/pagos';

            fetch(`${url}?inicio=${start}&fin=${end}`)
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('chartPagos').getContext('2d');
                    if (chartPago) chartPago.destroy();

                    chartPago = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: data.labels,
                            datasets: [{
                                data: data.data,
                                backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right' },
                                title: { display: true, text: 'Cantidad de Transacciones' }
                            }
                        }
                    });
                });
        }
    </script>
</body>
</html>